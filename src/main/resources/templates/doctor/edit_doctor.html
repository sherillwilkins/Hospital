<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>管理员</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Layui CSS -->
    <link rel="stylesheet" type="text/css" th:href="@{/plugins/layui/css/layui.css}">
    <!-- Main CSS-->
    <link rel="stylesheet" type="text/css" th:href="@{/plugins/awesome/css/main.css}">
    <!-- 自定义 -->
    <link rel="stylesheet" type="text/css" th:href="@{/plugins/awesome/css/patch.css}">
    <!-- Font-icon css-->
    <link rel="stylesheet" type="text/css" th:href="@{/plugins/awesome/css/font-awesome.min.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/plugins/font_1332398_z4m8t7izbwk.css}">
    <style>
        .app-content {
            margin-left: 0px;
            margin-top: 0px !important;
        }

        .layui-tab-content {
            padding: 0;
        }

        .layui-tab-card {
            box-shadow: 0 0px 5px 0 rgba(0, 0, 0, .0);
            border: 0;
        }

        .layui-tab-title {
            margin-bottom: 5px;
            border-radius: 3px;
        }

        .app-content {
            padding: 0px 12px;
            background-color: #fff;
        }
    </style>
</head>
<body>
<main class="app-content">
    <div class="row">
        <div class="col-md-12">
            <div class="layui-tab layui-tab-card">
                <ul class="layui-tab-title">
                    <li class="layui-this">医生信息</li>
                </ul>
                <div class="layui-tab-content" style="height: 100px;">
                    <div class="layui-tab-item layui-show">
                        <form id="admin-editapi">
                            <div class="tile">
                                <div class="row">
                                    <div class="col-lg-6">
                                        <div class="form-group">
                                            <label for="title">医生编号</label>
                                            <input class="form-control" id="title" type="text" aria-describedby="title"
                                                   name="title" th:value="${doctor.id}"
                                                   placeholder="医生编号">
                                        </div>
                                        <div class="form-group">
                                            <label for="desc">医生性别</label>
                                            <input class="form-control" id="desc" type="text" aria-describedby="desc"
                                                   name="desc" th:value="${doctor.gender}"
                                                   placeholder="将长网址进行缩短，支持百度、新浪、腾讯短网址等等。">
                                        </div>
                                        <div class="form-group">
                                            <label for="format">联系方式</label>
                                            <input class="form-control" id="format" type="text"
                                                   aria-describedby="format" name="format"
                                                   th:value="${doctor.telephone}" placeholder="联系方式">
                                        </div>
                                        <div class="form-group">
                                            <label for="ask">所属部门</label>
                                            <input class="form-control" id="ask" type="text" aria-describedby="ask"
                                                   name="ask" th:value="${doctor.departmentId}"
                                                   placeholder="所属部门">
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="form-group">
                                            <label for="alias">医生姓名</label>
                                            <input class="form-control" id="alias" type="text" aria-describedby="alias"
                                                   name="alias" th:value="${doctor.name}"
                                                   placeholder="医生姓名">
                                        </div>
                                        <div class="form-group">
                                            <label for="address">出生日期</label>
                                            <input class="form-control" id="address" type="text"
                                                   aria-describedby="address" name="address"
                                                   th:value="${doctor.birthday}"
                                                   placeholder="出生日期">
                                        </div>
                                        <div class="form-group">
                                            <label for="mode">职称</label>
                                            <input class="form-control" id="mode" type="text" aria-describedby="mode"
                                                   name="mode" th:value="${doctor.title}"
                                                   placeholder="职称">
                                        </div>
                                    </div>
                                </div>
                                <div class="tile-footer">
                                    <input type="hidden" value="addapi" name="target" style="display: none">
                                    <button type="button" class="btn btn-primary">保存</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Essential javascripts for application to work-->
<script th:src="@{/plugins/awesome/js/jquery-3.2.1.min.js}"></script>
<script th:src="@{/plugins/awesome/js/popper.min.js}"></script>
<script th:src="@{/plugins/awesome/js/bootstrap.min.js}"></script>
<script th:src="@{/plugins/awesome/js/main.js}"></script>
<!-- The javascript plugin to display page loading on top-->
<script th:src="@{/plugins/awesome/js/plugins/pace.min.js}"></script>
<!-- Page specific javascripts-->
<script th:src="@{/plugins/awesome/js/plugins/chart.js}"></script>
<!-- Data table plugin-->
<script type="text/javascript" th:src="@{/plugins/awesome/js/plugins/jquery.dataTables.min.js}"></script>
<script type="text/javascript" th:src="@{/plugins/awesome/js/plugins/dataTables.bootstrap.min.js}"></script>
<script th:src="@{/plugins/layui/layui.all.js}"></script>

<script>

    //选择类型
    function OptType(_this) {
        var type = _this.options[_this.selectedIndex].value;
        index = layer.load(1, {
            shade: [0.1, '#fff'] //0.1透明度的白色背景
        });

        fd = new FormData();
        fd.append("id", $('#optApi').val());
        fd.append("type", type);
        $.ajax({
            url: '/admin/getVal',
            type: "POST",
            timeout: "5000",
            dataType: "json",
            contentType: 'application/x-www-form-urlencoded;charset=utf-8',
            data: fd,
            contentType: false,
            processData: false,
            success: function (data) {
                if (data.code == "200") {
                    layer.close(index);
                    layer.msg(data.msg, {time: 1500});
                    FillVal(data.data);
                } else {
                    layer.close(index);
                    layer.msg(data.msg, {time: 1500});
                    FillVal(data.data);
                }
            },
            error: function (XMLResponse) {
                layer.close(index);
                layer.msg(XMLResponse.error);
            }
        });
    }

    //删除参数
    function DelVal(_this) {
        var td = _this.parentNode;
        var tr = td.parentNode;
        var tbody = tr.parentNode;
        var body = tbody.parentNode;
        console.log(_this.title);
        // body.removeChild(tbody);
        //询问框
        layer.confirm('确定删除参数？', {
            title: "提示",
            btn: ['删除', '取消 '] //按钮
        }, function () {
            fd = new FormData();
            fd.append("id", _this.title);
            $.ajax({
                url: '/admin/delval',
                type: "POST",
                timeout: "5000",
                dataType: "json",
                contentType: 'application/x-www-form-urlencoded;charset=utf-8',
                data: fd,
                contentType: false,
                processData: false,
                success: function (data) {
                    if (data.code == "200") {
                        layer.msg(data.msg, {time: 1500});
                        body.removeChild(tbody);
                    } else {
                        layer.msg(data.msg);
                    }
                },
                error: function (XMLResponse) {
                    layer.msg(XMLResponse.error);
                }
            });
        });
    }

    //填充参数
    function FillVal(data) {
        var val_code = '';
        console.log(data);
        if (data == '') {
            document.getElementById('apival').innerHTML = val_code;
            return;
        }
        data.forEach(element => {
            console.log(element.pid);
            val_code = val_code + '<div class="row"> <div class="col-lg-2"> <div class="form-group"> <label for="name0">参数名</label> <input class="form-control" id="name0" type="text" aria-describedby="name0" name="data[0][name]" value="' + element['p_name'] + '" placeholder="url"> </div> </div> <div class="col-lg-2"> <div class="form-group"> <label for="crux0">必填</label> <input class="form-control" id="crux0" type="text" aria-describedby="crux0" name="data[0][crux]" value="' + element['p_crux'] + '" placeholder="是"> </div> </div> <div class="col-lg-3"> <div class="form-group"> <label for="type0">参数类型</label> <input class="form-control" id="type0" type="text" aria-describedby="type0" name="data[0][type]" value="' + element['p_type'] + '" placeholder="string"> </div> </div> <div class="col-lg-4"> <div class="form-group"> <label for="desc0">参数说明</label> <input class="form-control" id="desc0" type="text" aria-describedby="desc0" name="data[0][desc]" value="' + element['p_desc'] + '" placeholder="需要进行操作网址"> </div> </div> <div class="col-lg-1"> <div class="form-group"> <label for="desc0">&nbsp操作</label> <input type="button" value="删除" title="' + element['p_id'] + '" onclick="DelVal(this)" class="form-control btn btn-danger btn-sm"></button> </div> </div> </div>';
        });
        console.log(val_code);
        document.getElementById('apival').innerHTML = val_code;
    }

    //获取字段
    $('#getField').click(function () {
        fd = new FormData();
        fd.append("field", $("#table").val());
        $.ajax({
            url: '/admin/getField',
            type: "POST",
            timeout: "3000",
            dataType: "json",
            contentType: 'application/x-www-form-urlencoded;charset=utf-8',
            data: fd,
            contentType: false,
            processData: false,
            success: function (data) {
                if (data.code == "200") {
                    layer.msg(data.msg);
                    $('#field').html(field_html(data.data));
                } else {
                    layer.msg(data.msg);
                }
            },
            error: function (XMLResponse) {
                layer.msg(XMLResponse.error);
            }
        });
    });

    //字段生成器
    function field_html(data) {
        var code_top = '<label for="ten">选择关联数据字段</label><br>';
        var code_main = '';
        var code_bottom = '';
        var i = 0;
        data.forEach(element => {
            code_main = code_main + '<div class="animated-checkbox xc"> <label> <input name="field[' + i + ']" type="checkbox" value="' + element + '"><span class="label-text">' + element + '</span> </label> </div>';
            i++;
        });
        return code_top + code_main;
    }

    //基本信息提交
    $('#admin-editapi button').click(function () {
        index = layer.load(1, {
            shade: [0.1, '#fff'] //0.1透明度的白色背景
        });
        fd = new FormData(document.getElementById('admin-editapi'));
        fd.append('id', $('#optApi').val())
        $.ajax({
            url: '/admin/editapi',
            type: "POST",
            timeout: "5000",
            dataType: "json",
            contentType: 'application/x-www-form-urlencoded;charset=utf-8',
            data: fd,
            contentType: false,
            processData: false,
            success: function (data) {
                layer.close(index);
                if (data.code == "200") {
                    layer.msg(data.msg, {time: 1500}, function () {
                        location.reload();
                    });
                } else {
                    layer.msg(data.msg);
                }
            },
            error: function (XMLResponse) {
                layer.msg(XMLResponse.error);
            }
        });
    });

    //添加数据
    $('#admin-datainfo button').click(function () {
        if ($("input[type='checkbox']").is(':checked')) {
            fd = new FormData(document.getElementById('admin-datainfo'));
            $.ajax({
                url: '/admin/datainfo',
                type: "POST",
                timeout: "5000",
                dataType: "json",
                contentType: 'application/x-www-form-urlencoded;charset=utf-8',
                data: fd,
                contentType: false,
                processData: false,
                success: function (data) {
                    if (data.code == "200") {
                        layer.msg(data.msg, {time: 1500}, function () {
                            location.reload();
                        });
                    } else {
                        layer.msg(data.msg);
                    }
                },
                error: function (XMLResponse) {
                    layer.msg(XMLResponse.error);
                }
            });
        } else {
            layer.msg("请先选择关联字段");
        }
    });

    //价格
    $('#admin-charge button').click(function () {
        if ($("input[type='checkbox']").is(':checked')) {
            fd = new FormData(document.getElementById('admin-charge'));
            fd.append("id", $('#optApi').val());
            $.ajax({
                url: '/admin/charge',
                type: "POST",
                timeout: "5000",
                dataType: "json",
                contentType: 'application/x-www-form-urlencoded;charset=utf-8',
                data: fd,
                contentType: false,
                processData: false,
                success: function (data) {
                    if (data.code == "200") {
                        layer.msg(data.msg, {time: 1500}, function () {
                            location.reload();
                        });
                    } else {
                        layer.msg(data.msg);
                    }
                },
                error: function (XMLResponse) {
                    layer.msg(XMLResponse.error);
                }
            });
        } else {
            layer.msg("请先选择关联字段");
        }
    });

    /*提交按下*/
    $('#admin-apiinfo button').click(function () {
        //判断是否存在接口
        if ($('#optApi').val() == null) {
            layer.msg("请选择绑定接口");
            return;
        }
        /*实例化表单数据*/
        var fd = new FormData(document.getElementById('admin-apiinfo'));
        $.ajax({
            url: '/admin/apiinfo',
            type: "POST",
            timeout: "5000",
            dataType: "json",
            contentType: 'application/x-www-form-urlencoded;charset=utf-8',
            data: fd,
            contentType: false,
            processData: false,
            success: function (data) {
                if (data.code == "200") {
                    layer.msg(data.msg, {time: 1000}, function () {
                        location.reload();
                    });
                } else {
                    layer.msg(data.msg);
                }
            },
            error: function (XMLResponse) {
                layer.msg(XMLResponse.error);
            }
        });
    });

</script>

</body>
</html>